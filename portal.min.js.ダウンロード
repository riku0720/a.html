var vimana=vimana||{},portal=portal||{};
(function(){vimana.factory=vimana.factory||{};vimana.util=vimana.util||{};portal.navi=portal.navi||{};portal.index=portal.index||{};portal.inside=portal.inside||{};portal.lecture=portal.lecture||{};portal.group=portal.group||{};portal.calender=portal.calender||{};portal.config=portal.config||{};portal.help=portal.help||{};portal.plugin=portal.plugin||{};portal.teu=portal.teu||{};portal.data=portal.data||{};portal.data.myinfo=portal.data.myinfo||{};portal.data.allExtendPlugins=portal.data.allExtendPlugins||
[];portal.data.keyCode=portal.data.keyCode||{enter:13};portal.data.timer=portal.data.timer||{};portal.data.timer.storage=portal.data.timer.storage||{timerId:0,lastUpdate:0};portal.data.timer.plugin=portal.data.timer.plugin||{timerId:0,lastUpdate:0};$(document).ready(function(){vimana.init("/portal")});$(document).on("vimana-init",function(){portal.init()});portal.init=function(){var a;a=window.history&&window.history.pushState?!0:!1;a||M('推奨環境に該当しない環境を利用しています。一部の機能が正しく閲覧できない可能性があります。( \x3ca href\x3d"/portal/help/requirement" class\x3d"pjax"\x3eヘルプ: 推奨環境について\x3c/a\x3e ) ');
$.ajax({type:"GET",url:"/portal/api/myinfo",dataType:"text",success:function(a){portal.data.myinfo=JSON.parse(a);a=portal.data.myinfo.user_id;localStorage.getItem("user_id")!==a&&(localStorage.clear(),localStorage.setItem("user_id",a));a=portal.data.myinfo.extention.storage;var c=m(),d=c.lastupdate,e=a.lastupdate;vimana.util.arrayKeyExists("lastupdate",c)&&vimana.util.arrayKeyExists("lastupdate",a)&&isFinite(d)&&isFinite(e)?(d=parseInt(d,10),e=parseInt(e,10),portal.data.timer.storage.lastUpdate=e,
d<e?C(a):d>e&&D(c,null,null)):vimana.util.arrayKeyExists("lastupdate",a)&&isFinite(a.lastupdate)?(portal.data.timer.storage.lastUpdate=parseInt(e,10),C(a)):E();z(m("style"));N();F.init();a=$("body\x3eheader\x3ediv.profile-box .student-id");var c=$("body\x3eheader\x3ediv.profile-box .user-name"),d=$(".content-active"),e=portal.data.myinfo.firstname,f=portal.data.myinfo.lastname;a.text(portal.data.myinfo.user_id).hide();c.text(e+" "+f);d.trigger("hpjax:not",location.pathname).trigger("hpjax:show",location.pathname);
for(var g in portal.data.myinfo.groups)if("iwb"===portal.data.myinfo.groups[g].name)try{$.iwbox({super_minimum:!0})}catch(h){console.error(h)}}})};portal.index={init:function(){A.addEvent()}};portal.inside={init:function(){v.addEvent();var a=m("inside_path");a?v.load(a):v.setInsidePathForm()}};portal.lecture={init:function(){s.addEvent()}};portal.lecture.search={init:function(){q.addEvent();q.addKeyEvent()}};portal.teacher={init:function(){O.addEvent()}};portal.group={init:function(){u.addEvent()}};
portal.group.management={init:function(){n.addEvent()}};portal.calendar={init:function(){t.addEvent();t.addKeyEvent();var a=m("calendar_id");a?t.load(a):t.setCalenderIdForm()}};portal.config={init:function(){x.addEvent();x.addKeyEvent();x.initValue()}};portal.config.plugin={init:function(){w.addEvent();w.addKeyEvent()}};portal.help={init:function(){P.addEvent()}};var F={init:function(){"faculty"!==portal.data.myinfo.job&&($("#navi-teacher").hide(),$("#navi-group").hide());F.addEvent()},addEvent:function(){$(document).hpjax("a.hpjax",
"#contents");var a=$("#global-navi"),b=$("#contents"),c=location.pathname.match(/\/portal\/(.+)\//);null!==c&&$("#navi-group"+c[1]).addClass("navi-active");b.on("hpjax:show",function(a,c){var b=c.replace("/portal/","").split("/")[0],g="TUT Portal | "+(b.charAt(0).toUpperCase()+b.slice(1));document.title=g;$("#navi-"+b).addClass("navi-active")});b.on("hpjax:hide",function(c){a.find(".navi-active").removeClass("navi-active")})}},A={addEvent:function(){var a=$("#panel-index");a.on("hpjax:not",function(a){});
a.on("hpjax:loaded",function(){});a.on("hpjax:cached",function(){});a.on("hpjax:show",function(a){A.pluginsInit()});a.on("hpjax:hide",function(a){})},pluginsInit:function(){var a=portal.data.myinfo,b={user_id:a.user_id,firstname:a.firstname,lastname:portal.data.myinfo.lastname},c=[];vimana.util.arrayKeyExists("extention",a)&&(vimana.util.arrayKeyExists("defaultPlugins",a.extention)&&(c=c.concat(a.extention.defaultPlugins)),vimana.util.arrayKeyExists("enableExtendPlugins",a.extention)&&(c=c.concat(a.extention.enableExtendPlugins)));
vimana.plugin.init(c,b)}},v={addEvent:function(){var a=$("#panel-inside"),b=$("#init-inside-path"),c=b.find(".portal-button");a.on("hpjax:not",function(a){});a.on("hpjax:loaded",function(a){});a.on("hpjax:cached",function(a){});a.on("hpjax:show",function(a){m("inside_path");a="/inside2/";for(var c=0;c<portal.data.myinfo.groups.length;c++){var b=portal.data.myinfo.groups[c];if("ando"==portal.data.myinfo.ldap_id){a="/inside2/hachiouji/seibutsu/";break}if("bsb"==b.name||"btb"==b.name){a="/inside2/hachiouji/seibutsu/";
break}else if("csb"==b.name){a="/inside2/hachiouji/computer_science/";break}else if("dsb"==b.name){a="/inside2/kamata/design/";break}else if("msb"==b.name){a="/inside2/hachiouji/media/";break}else if("hsb"==b.name){a="/inside2/kamata/medical_health/";break}else if("enb"==b.name){a="/inside2/hachiouji/engineering/";break}else if("bsg"==b.name||"csg"==b.name||"msg"==b.name||"atg"==b.name||"eng"==b.name||"aug"==b.name){a="/inside2/hachiouji/graduate_school/";break}else if("hsg"==b.name||"dsg"==b.name){a=
"/inside2/kamata/graduate_school/";break}}v.load(a)});a.on("hpjax:hide",function(a){});c.on("click",function(){var a=b.find('input[name\x3d"inside-path"]:checked').val();a&&(r("inside_path",a),v.load(a))})},setInsidePathForm:function(){var a=$("#inside-viwer");$("#init-inside-path").show();a.removeClass("active").hide()},load:function(a){var b=$("#inside-viwer"),c=$("#init-inside-path");b.hasClass("active")&&b.attr("src")===a||(c.hide(),b.attr("src",a).addClass("active").show())}},s={addEvent:function(){var a=
$("#panel-lecture");a.on("hpjax:not",function(a){});a.on("hpjax:loaded",function(a){});a.on("hpjax:cached",function(a){});a.on("hpjax:show",function(a){s.load()});a.on("hpjax:hide",function(a){})},load:function(){$.ajax({type:"GET",url:"/portal/api/api-rest/lecture/search",data:{user_code:portal.data.myinfo.ldap_id},dataType:"text",success:function(a){a=JSON.parse(a);var b=$("#lecture-cards"),c=m("pickUpLectures"),d={};c&&(d=JSON.parse(c));for(var e in a){var c=a[e],f="";d[c.lecture_code]&&(f=d[c.lecture_code].memo||
"");d[c.lecture_code]=c;d[c.lecture_code].memo=f;d[c.lecture_code].isRegular=!0}s.createLinkTable(d);b.find(".lecture-card").remove();$.each(d,function(a,c){if($("#lecture-"+a).length)return!0;var d=s.createCard(a,c);b.append(d)})},error:function(a){console.error(a)}})},createLinkTable:function(a){$("#lecture-navi").find(".lecture-navi-link").remove();var b=$("#lecture-navi");$.each(a,function(a,d){if(b.find('a[href\x3d"/portal/lecture#lecture-'+a+'"]').length)return!0;var e=$("#portal-timetable-faster"),
f=$("#portal-timetable-later"),g=$(),h=$("#portal-timetable-others"),k=$("\x3ca /\x3e",{"class":"hpjax lecture-navi-link",id:"lecture-navi-"+a,href:"/portal/lecture#lecture-"+a}).text(d.name);if(vimana.util.arrayKeyExists("turn_info",d)){var p=d.turn_info[0].day.toLowerCase(),l=d.turn_info[0].period;"前期"==d.term?g=e.find(".portal-timetable-"+p+l):"後期"==d.term&&(g=f.find(".portal-timetable-"+p+l))}g.length?g.append(k):h.append(k)})},createCard:function(a,b){var c=$("#template-lecture-card").clone(),
d=c.find(".portal-icon-button");c.attr("id","lecture-"+a).addClass("lecture-card").attr("data-lecture-id",a);if(b.isRegular)d.hide();else d.on("click",function(c){c=$(this).find(".icon");var b=$(this).closest(".content-part"),d=b.attr("data-lecture-id"),e=m("pickUpLectures"),g={};e&&(g=JSON.parse(e));c.hasClass("delete-icon")?window.confirm("削除します")&&(delete g[d],r("pickUpLectures",JSON.stringify(g)),b.remove(),$("#lecture-navi-"+a).remove()):c.hasClass("renew-icon")&&s.renew(d,$(this))});c.find(".lecture-name").text(b.name);
c.find(".lecture-year").text(b.year);c.find(".lecture-term").text(b.term);d=c.find(".lecture-registration-state");if(b.isRegular)if(b.is_temp){var e=$("\x3cdiv /\x3e",{"class":"portal-button"}).css({"float":"right"}).text("仮履修の取り消し");e.on("click",{lectureCode:a},function(a){s.unregister(a.data.lectureCode)});d.text("仮履修中").append(e)}else d.text("履修中");else d.text("その他");c.find(".lecture-url a").attr("href",b.url);c.find(".lecture-url a.lecture-url-link").text(b.url);d=c.find(".lecture-begin-series-info");
if(vimana.util.arrayKeyExists("turn_info",b))for(var f in b.turn_info){var e=b.turn_info[f],g=$("\x3cdl /\x3e").addClass("under-space");g.append($("\x3cdt /\x3e").text("教員"));g.append($("\x3cdd /\x3e").text(e.teacher_code));g.append($("\x3cdt /\x3e").text("教室"));g.append($("\x3cdd /\x3e").text(e.room_code));g.append($("\x3cdt /\x3e").text("週"));for(var h=0;h<e.turn.length;h++)e.turn[h]++;g.append($("\x3cdd /\x3e").text(e.turn.join(",")));d.append(g)}f=c.find(".lecture-user-memo");b.memo&&f.find(".portal-textarea").text(b.memo);
f.find(".portal-button").on("click",function(){var a=$(this).closest(".content-part"),c=a.find(".lecture-user-memo"),a=a.attr("data-lecture-id"),b=m("pickUpLectures"),d={};b&&(d=JSON.parse(b));vimana.util.arrayKeyExists(a,d)&&(c=c.find(".portal-textarea").val(),d[a].memo=c);r("pickUpLectures",JSON.stringify(d))});return c},renew:function(a,b){var c=$(b);Q(c);$.ajax({type:"GET",url:"/portal/api/api-rest/lecture/search",data:{lecture_code:a},dataType:"text",success:function(a){var b=JSON.parse(a),f=
b.lecture_code,g=m("pickUpLectures"),h={};a=$("#lecture-"+f);g&&(h=JSON.parse(g));g=h[f].memo||"";h[f]=b;h[f].memo=g;r("pickUpLectures",JSON.stringify(h));b=s.createCard(f,h[f]);b.find(".portal-icon-button").has(".renew-icon").hide().after(c).remove();a.hide().after(b).remove();c.trigger("rotate:stop")},error:function(a){console.error(a);b.trigger("rotate:stop")}})},unregister:function(a){$.ajax({type:"POST",url:"/portal/api/api-rest/lecture/delete/temporary",dataType:"text",data:{user_code:portal.data.myinfo.ldap_id,
lecture_code:a},success:function(b){b=$("#lecture-navi-"+a);var c=$("#lecture-"+a);b.remove();c.remove()},error:function(a){console.error(a)}})}},q={addEvent:function(){var a=$("#panel-lecture-search"),b=$("#lecture-search"),c=$("#lecture-search-result"),d=a.find(".page-navi"),e=d.find(".portal-icon-button");a.on("hpjax:not",function(a){});a.on("hpjax:loaded",function(a){});a.on("hpjax:cached",function(a){});a.on("hpjax:show",function(a){c.find("tr.result-row").length||($(".page-navi").hide(),c.hide())});
a.on("hpjax:hide",function(a){});b.find(".portal-button").on("click",function(){q.wordSearch()});e.on("click",function(){var a=$(this).find(".icon"),b=c.attr("data-query-name"),e=c.attr("data-query-campus"),k=$(d.find(".page-num")[0]).text(),p=$(d.find(".max-page-num")[0]).text(),l={name:b,campus:e};b&&e&&isFinite(k)&&isFinite(p)&&(k=parseInt(k,10),p=parseInt(p,10),a.hasClass("left-arrows-icon")?l.page_num=1:a.hasClass("left-arrow-icon")?l.page_num=k-1:a.hasClass("right-arrow-icon")?l.page_num=k+
1:a.hasClass("right-arrows-icon")&&(l.page_num=p),1>l.page_num||p<l.page_num||q.sendQuery(l))})},addKeyEvent:function(){$("#lecture-search").find(".portal-text").on("keypress",function(a){a.keyCode===portal.data.keyCode.enter&&q.wordSearch()})},wordSearch:function(){var a=$("#lecture-search"),b=$("#lecture-search-result"),c=$("#lecture-search-message"),d=a.find(".portal-text").val(),a=a.find('input[name\x3d"campus"]:checked').val(),e={name:d,campus:a};2>d.length?(c.text("2字以上で検索して下さい").show(),setTimeout(function(){c.fadeOut("slow")},
2E3)):(b.attr("data-query-name",d).attr("data-query-campus",a),q.sendQuery(e))},resultData:{},createResult:function(a){var b=$("#lecture-search-result"),c=$("#panel-lecture-search .page-navi"),d=$("#lecture-search-message");a=q.resultData=a;b.find(".result-row").remove();1<a.max_page_num?(c.show(),c.find(".page-num").text(a.page_num),c.find(".max-page-num").text(a.max_page_num)):c.hide();if(0<a.result.length){b.show();for(var e in a.result){var c=a.result[e],f=$("#template-lecture-search-result").clone();
f.attr("id","").addClass("result-row");f.find(".lecture-year").text(c.year);f.find(".lecture-term").text(c.term);f.find(".lecture-name").text(c.name);f.find(".lecture-teacher").text(c.turn_info[0].teacher_code);f.find(".portal-button").on("click",{index:e},function(a){$(this).hasClass("preview")?q.showLecturePreview(a.data.index):$(this).hasClass("pickUp")&&q.setPickUpLectures(a.data.index)});b.find("tbody").append(f)}}else b.hide(),d.text("検索結果はありません").show(),setTimeout(function(){d.fadeOut("slow")},
2E3)},showLecturePreview:function(a){a=q.resultData.result[a];var b=s.createCard(a.lecture_code,a);a=b.find(".portal-icon-button");var c=b.find(".lecture-user-memo");a.remove();c.remove();vimana.factory.floatwindow({windowObject:[b],windowProperty:{width:"480px",height:"520px",outerClick:"delete"},callback:function(){var a=$(".portal-floatwindow-content").height();b.height()<a?b.css({position:"relative",top:"50%",margin:"0 auto","-webkit-transform":"translateY(-50%)","-ms-transform":"translateY(-50%)",
transform:"translateY(-50%)"}):b.css({margin:"0 auto"})}})},setPickUpLectures:function(a){var b=$("\x3cp /\x3e"),c=$("\x3cdiv /\x3e"),d=m("pickUpLectures");a=q.resultData.result[a];var e={};d&&(e=JSON.parse(d));30<=Object.keys(e).length?(b.text("ピン留めは30件までです").show(),setTimeout(function(){b.fadeOut("slow")},2E3)):(e[a.lecture_code]=a,r("pickUpLectures",JSON.stringify(e)),b.css({"text-align":"center"}).text("「"+a.name+"」をピン留めしました"),c.css({position:"relative",top:"50%",margin:"0 auto","-webkit-transform":"translateY(-50%)",
"-ms-transform":"translateY(-50%)",transform:"translateY(-50%)"}).append(b),vimana.factory.floatwindow({windowObject:[c],windowProperty:{width:"480px",height:"200px",outerClick:"delete"}}))},sendQuery:function(a){$.ajax({type:"GET",url:"/portal/api/api-rest/lecture/search",dataType:"text",data:a,success:function(a){a=JSON.parse(a);q.createResult(a)},error:function(a){var c=$("#lecture-search-message");c.text("エラーが発生しました．もう一度検索をお願いします").show();setTimeout(function(){c.fadeOut("slow")},2E3)}})}},O={addEvent:function(){var a=
$("#panel-teacher"),b=a.find(".portal-iframe");a.on("hpjax:not",function(a){});a.on("hpjax:loaded",function(a){});a.on("hpjax:cached",function(a){});a.on("hpjax:show",function(a){b.attr("src","/neptune/")});a.on("hpjax:hide",function(a){})}},u={addEvent:function(){var a=$("#panel-group"),b=$("#create-group-area"),c=$("#search-group-area");a.on("hpjax:not",function(a){});a.on("hpjax:loaded",function(a){});a.on("hpjax:cached",function(a){});a.on("hpjax:show",function(a){u.grouplistInit()});a.on("hpjax:hide",
function(a){});b.find(".portal-button").on("click",function(){var a=b.find(".portal-text"),c={group_name:a.val()};a.val("");u.sendQuery("create",c)});c.find(".portal-button").on("click",function(){var a=c.find(".portal-text"),b={group_name:a.val()};a.val("");u.sendQuery("search",b)})},grouplistInit:function(){var a=$("#owner-group .content-part-body ul"),b=$("#membership-group .content-part-body ul");a.empty();b.empty();portal.data.myinfo.groups.sort(function(a,c){return a.name>c.name?1:a.name<c.name?
-1:0});var c=portal.data.myinfo,d;for(d in c.groups){var e=c.groups[d];if(!$("#group-name-"+e.name).length){var f=$("\x3cli /\x3e",{id:"group-name-"+e.name}).text(e.name);if(c.hornet_id===e.owner){var g=vimana.factory.button("メンバー管理"),h=vimana.factory.button("削除");g.on("click",{group_name:e.name},function(a){$.hpjax("/portal/group/management?group_name\x3d"+a.data.group_name)});h.on("click",{group_name:e.name},function(a){var c=$("\x3cp /\x3e"),b=vimana.factory.textLine("正確にグループ名を入力して下さい"),d=vimana.factory.button("実行"),
e=$("\x3cdiv /\x3e");c.text("グループ削除の最終確認になります．");b.css({width:"300px"});e.css({padding:"65px 20px"}).append(c).append(b).append(d);var g=vimana.factory.floatwindow({windowObject:[e],windowProperty:{width:"400px",height:"200px",outerClick:"delete"}}),f={group_name:a.data.group_name};d.on("click",function(a){f.group_name===b.val()?(u.sendQuery("delete",f),g.remove()):(b.val(""),b.attr("placeholder","グループ名を確認してもう一度入力して下さい"))})});a.append(f.append(h).append(g))}else b.append(f)}}},sendQuery:function(a,
b,c){"function"!==typeof c&&(c=function(a){a=JSON.parse(a);portal.data.myinfo.groups=a.groups;u.grouplistInit()});var d="POST";"search"===a&&(d="GET");$.ajax({type:d,url:"/portal/api/group/"+a,data:b,dataType:"text",success:c,error:function(a){console.error(a)}})}},n={addEvent:function(){var a=$("#group-management-name"),b=$("#panel-group-management"),c=$("#group-management-search-by-student-id"),d=c.find(".portal-notice");b.on("hpjax:not",function(a){});b.on("hpjax:loaded",function(a){});b.on("hpjax:cached",
function(a){});b.on("hpjax:show",function(c){n.load(1);d.hide();a.text(n.getGroupName())});b.on("hpjax:hide",function(a){});c.find(".portal-button").on("click",function(){var a=c.find(".portal-textarea"),b=a.val().split(/,|\r|\n|\s|\t/),e=[],k=[],p;for(p in b){var l=b[p];B(l)?e.push(l):k.push(l)}n.joinMember(e);a.val("");d.hide();k.length&&d.text(k.join()+"の入力値が不正です").show()});var e=b.find(".page-navi");e.find(".portal-icon-button").on("click",function(){var a=$("this").find(".icon"),b=$(e.find(".page-num")[0]).text();
isFinite(b)&&(b.parseInt(b,10),a.hasClass("left-arrow-icon")?b--:a.hasClass("right-arrow-icon")&&b++,1>b||n.load(b))})},getGroupName:function(){var a=window.location.search.substr(1).split("\x26"),b;for(b in a){var c=a[b].split("\x3d"),d=decodeURIComponent(c[0]),c=decodeURIComponent(c[1]);if("group_name"===d)return c}return""},load:function(a){a={group_name:n.getGroupName(),page_num:a};$.ajax({type:"GET",url:"/portal/api/group/members",data:a,dataType:"text",success:function(a){a=JSON.parse(a);n.createMemberList(a)},
error:function(a){console.error(a)}})},createMemberList:function(a){var b=a.members_list,c=a.page_num;a=$("#group-members");var d=$("#panel-group-management .page-navi");a.empty();d.find(".page-num").text(c);for(var e in b){var c=b[e],d=$("\x3ctd /\x3e",{"class":"member-list-student-id"}).text(c.user_id),f=$("\x3ctd /\x3e",{"class":"member-list-firstname"}).text(c.firstname),g=$("\x3ctd /\x3e",{"class":"member-list-lastname"}).text(c.lastname),h=vimana.factory.button("削除"),k=$("\x3ctr /\x3e");h.on("click",
{studentId:c.user_id},function(a){portal.data.myinfo.user_id!==a.data.studentId&&n.leaveMember([a.data.studentId])});k.append(d).append(f).append(g).append($("\x3ctd /\x3e").append(h));a.append(k)}},joinMember:function(a){var b={group_name:n.getGroupName()},c=[],d;for(d in a){var e=a[d];B(e)&&c.push(e)}b.join_member=JSON.stringify(c);n.sendQuery(b)},leaveMember:function(a){var b={group_name:n.getGroupName()},c=[],d;for(d in a){var e=a[d];B(e)&&c.push(e)}b.leave_member=JSON.stringify(c);n.sendQuery(b)},
sendQuery:function(a){"string"===typeof a.group_name&&a.group_name||(a.group_name=n.getGroupName());"string"===typeof a.join_member&&a.join_member||(a.join_member=JSON.stringify([]));"string"===typeof a.leave_member&&a.leave_member||(a.leave_member=JSON.stringify([]));$.ajax({type:"POST",url:"/portal/api/group/update",data:a,dataType:"text",success:function(a){n.load(1)},error:function(a){console.error(a)}})}},t={addEvent:function(){var a=$("#panel-calendar"),b=$("#init-calendar-id");a.on("hpjax:not",
function(a){});a.on("hpjax:loaded",function(a){});a.on("hpjax:cached",function(a){});a.on("hpjax:show",function(a){(a=m("calendar_id"))?t.load(a):t.setCalenderIdForm()});a.on("hpjax:hide",function(a){});b.find(".portal-button").on("click",function(){var a=b.find(".portal-text").val();a&&(r("calendar_id",a),t.load(a))})},addKeyEvent:function(){var a=$("#init-calendar-id");a.find(".portal-text").on("keypress",function(b){b.keyCode===portal.data.keyCode.enter&&(b=a.find(".portal-text").val())&&(r("calendar_id",
b),a.hide(),t.load(b))})},setCalenderIdForm:function(){var a=$("#init-calendar-id"),b=$("#calendar-viwer");a.show();b.removeClass("active").hide()},load:function(a){var b=$("#init-calendar-id"),c=$("#calendar-viwer"),d;switch(m("style")){case "red":d="\x26color\x3d%23691426";break;case "blue":d="\x26color\x3d%23182C57";break;case "green":d="\x26color\x3d%23125A12";break;default:d="\x26color\x3d%232952A3"}d="https://www.google.com/calendar/embed?showTitle\x3d0\x26showPrint\x3d0\x26showTz\x3d0\x26height\x3d600\x26wkst\x3d1\x26bgcolor\x3d%23FFFFFF\x26src\x3d"+
(encodeURIComponent(a)+d)+"\x26ctz\x3dAsia%2FTokyo";a||(d="");c.hasClass("active")||c.attr("src")===d||(b.hide(),c.attr("src",d).addClass("active").show())}},x={addEvent:function(){var a=$("#panel-config"),b=$("#set-inside-path"),c=$("#set-calendar-id"),d=$("#select-style"),e=$("#clear-storage"),f=$("#oldPasswd"),g=$("#newPasswd"),h=$("#checkPasswd"),k=$("#sendPasswd"),p=$("#passwd-errors\x3eli"),l=$("#remove-openId").find(".portal-button");a.on("hpjax:not",function(a){});a.on("hpjax:loaded",function(a){});
a.on("hpjax:cached",function(a){});a.on("hpjax:show",function(a){x.initValue()});a.on("hpjax:hide",function(a){});b.find(".portal-label").on("click",function(a){a=$(this).find('input[name\x3d"inside-path"]');var b=a.val();a[0].checked=!0;r("inside_path",b)});c.find(".portal-button").on("click",function(a){if(a=c.find(".portal-text").val())r("calendar_id",a),$.hpjax("/portal/calendar")});d.find("td").on("click",function(a){a=$(this).find('input[name\x3d"style"]');var b=a.val();a[0].checked=!0;r("style",
b);z(b)});e.find(".portal-button").on("click",function(a){a=$("#panel-index");var b=c.find(".portal-text"),e=d.find('input[name\x3d"style"][value\x3d"default"]');E();z(e.val());a.length&&(a.children().remove(),A.pluginsInit());b.val("");e[0].checked=!0});g.focus(function(){""!==$(this).val()&&G($(this).val())}).blur(function(){""===$(this).val()&&p.filter(".warning:not(#passwd-notMatchError)").removeClass("warning")});h.focus(function(){""!==$(this).val()&&H($(this).val())}).blur(function(){""===
$(this).val()&&p.filter("#passwd-notMatchError").removeClass("warning")});k.on("click",function(){if(I()){var a=$("\x3clabel /\x3e",{"class":"portal-label"}).css({"float":"right",padding:"2px 10px"}).text("updating");$(this).after(a);J(f.val(),g.val(),a)}});l.on("click",function(){R()})},addKeyEvent:function(){var a=$("#set-calendar-id").find(".portal-text"),b=$("#oldPasswd"),c=$("#newPasswd"),d=$("#checkPasswd"),e=$("#sendPasswd"),f=$("#passwd-errors\x3eli");a.on("keypress",function(a){a.keyCode===
portal.data.keyCode.enter&&(a=$(this).val())&&(r("calendar_id",a),$.hpjax("/portal/calendar"))});b.on("keypress",function(a){a.keyCode===portal.data.keyCode.enter&&(a.preventDefault(),c.focus())});c.on("keypress",function(a){a.keyCode===portal.data.keyCode.enter&&(a.preventDefault(),K($(this).val())&&d.focus())}).on("keyup",function(){""!==$(this).val()?G($(this).val()):f.filter(".warning:not(#passwd-notMatchError)").removeClass("warning")});d.on("keypress",function(a){a.keyCode===portal.data.keyCode.enter&&
(a.preventDefault(),I()&&(a=$("\x3clabel /\x3e",{"class":"portal-label"}).css({"float":"right",padding:"2px 10px"}).text("updating"),e.after(a),J(b.val(),c.val(),a)))}).on("keyup",function(){""!==$(this).val()?H($(this).val()):$("#passwd-notMatchError.warning").removeClass("warning")})},initValue:function(){$("#set-inside-path").find('input[name\x3d"inside-path"]');var a=$("#set-calendar-id").find(".portal-text"),b=$("#select-style").find('input[name\x3d"style"]');m("inside_path");var c=m("calendar_id"),
d=m("style");c?a.val(c):a.val("");d?b.filter('[value\x3d"'+d+'"]')[0].checked=!0:b.filter('[value\x3d"default"]')[0].checked=!0}},w={addEvent:function(){$configPlugin=$("#panel-config-plugin");$configPlugin.on("hpjax:not",function(a){});$configPlugin.on("hpjax:loaded",function(a){});$configPlugin.on("hpjax:cached",function(a){});$configPlugin.on("hpjax:show",function(a){w.load()});$configPlugin.on("hpjax:hide",function(a){})},addKeyEvent:function(){},createPluginConfCards:function(){for(var a=portal.data.allExtendPlugins,
b=portal.data.myinfo.extention.enableExtendPlugins,c=$("#plugin-cards").empty(),d=0,e;e=a[d];d++){var f=vimana.factory.contentPart(),g=f.find("h1.content-part-title"),h=f.find("div.content-part-body"),k=0<=b.indexOf(e),k=vimana.factory.toggle({on:function(a){portal.data.myinfo.extention.enableExtendPlugins.push(a);L(portal.data.myinfo.extention.enableExtendPlugins,null,null)},off:function(a){for(var c=portal.data.myinfo.extention.enableExtendPlugins,d=0,e;e=b[d];d++)e===a&&(b.splice(d,1),d--);L(c,
null,null)},initial:k,args:e});g.text(e);h.append(k);c.append(f)}},load:function(){0<portal.data.allExtendPlugins.length?w.createPluginConfCards():$.ajax({type:"GET",url:"/portal/default-api/get/plugins",dataType:"text",success:function(a){portal.data.allExtendPlugins=JSON.parse(a);w.createPluginConfCards()},error:function(a){console.error(a)}})}},P={addEvent:function(){var a=$("#panel-help"),b=a.find(".portal-iframe");a.on("hpjax:show",function(a){"faculty"===portal.data.myinfo.job&&"/edu_help/"!==
b.attr("src")&&b.attr("src","/edu_help/")})}},B=function(a){return a.match(/^[a-zA-z][0-9]{7}$/)},K=function(a){return a.match(/^[0-9A-Za-z!-\/:;=@\[\]-`{-~]{8,32}$/)&&a.match(/[0-9]/)&&a.match(/[a-z]/)&&a.match(/[A-Z]/)&&a.match(/[!-\/:;=@\[\]-`{-~]/)},I=function(){return $("#newPasswd").val()===$("#checkPasswd").val()},G=function(a){$("#passwd-errors\x3eli.warning").removeClass("warning");(8>a.length||32<a.length)&&$("#passwd-lengthError").addClass("warning");a.match(/^[0-9A-Za-z!-\/:;=@\[\]-`{-~]+$/)||
$("#passwd-LiteralError").addClass("warning");a.match(/[0-9]/)||$("#passwd-notUsedNumberError").addClass("warning");a.match(/[a-z]/)||$("#passwd-notUsedSmallLetterError").addClass("warning");a.match(/[A-Z]/)||$("#passwd-notUsedCapitalLetterError").addClass("warning");a.match(/[!-\/:;=@\[\]-`{-~]/)||$("#passwd-notUsedSymbolError").addClass("warning")},H=function(a){$("#passwd-notMatchError").removeClass("warning");$("#newPasswd").val()!==a&&$("#passwd-notMatchError").addClass("warning")},J=function(a,
b,c){K(b)?$.ajax({type:"POST",url:"/portal/api/ldap/password/update",data:{passwordObject:JSON.stringify({oldpassword:a,newpassword:b})},dataType:"text",success:function(a){$("#change-password .portal-password").val("");c.text("ok");setTimeout(function(){c.fadeOut("slow",function(){c.remove()})},2E3)},error:function(a){c.addClass("portal-notice").text("失敗しました");setTimeout(function(){c.fadeOut("slow",function(){c.remove()})},2E3)}}):(c.addClass("portal-notice").text("失敗しました"),setTimeout(function(){c.fadeOut("slow",
function(){c.remove()})},2E3))},R=function(){var a=$("\x3cp /\x3e"),b=$("\x3cdiv /\x3e");a.css({"text-align":"center"});b.css({position:"relative",top:"50%",margin:"0 auto","-webkit-transform":"translateY(-50%)","-ms-transform":"translateY(-50%)",transform:"translateY(-50%)"}).append(a);vimana.factory.floatwindow({windowObject:[b],windowProperty:{width:"480px",height:"200px",outerClick:"delete"}});$.ajax({type:"POST",url:"/portal/api/open-id/remove",dataType:"text",success:function(b){b=new Date;
var d="."+location.host;b.setYear(b.getYear()-1);document.cookie="auth_tkt\x3d; path\x3d/; domain\x3d"+d+"; expires\x3d"+b.toGMTString();a.text("現在のGoogleアカウントとの連携が解除されました。")},error:function(b){a.text("サーバエラーが発生しました。もう一度やり直して下さい。")}})},m=function(a){var b=localStorage.getItem("portal")||"{}",b=JSON.parse(b);return a?vimana.util.arrayKeyExists(a,b)?"object"===typeof b[a]?JSON.stringify(b[a]):b[a]:"":b},r=function(a,b){if(a){var c=localStorage.getItem("portal")||"{}",c=JSON.parse(c);c[a]=b;c.lastupdate=
(new Date).getTime();D(c,null,null);c=JSON.stringify(c);localStorage.setItem("portal",c)}},C=function(a){a=JSON.stringify(a);localStorage.setItem("portal",a)},E=function(){localStorage.clear();r("style","default")},D=function(a,b,c){if(isFinite(a.lastupdate)){var d={upload_data:JSON.stringify({storage:JSON.stringify(a)})};portal.data.timer.storage.lastUpdate+6E4<parseInt(a.lastupdate,10)?(portal.data.timer.storage.lastUpdate=parseInt(a.lastupdate,10),y(d,b,c)):(portal.data.timer.storage.timerId&&
isFinite(portal.data.timer.storage.timerId)&&clearTimeout(portal.data.timer.storage.timerId),portal.data.timer.storage.timerId=setTimeout(function(){portal.data.timer.storage.lastUpdate=parseInt(a.lastupdate,10);y(d,b,c)},6E4))}},L=function(a,b,c){var d={upload_data:JSON.stringify({enableExtendPlugins:JSON.stringify(a)})};portal.data.timer.plugin.lastUpdate+6E4<(new Date).getTime()?(portal.data.timer.plugin.lastUpdate=parseInt((new Date).getTime(),10),y(d,b,c)):(portal.data.timer.plugin.timerId&&
isFinite(portal.data.timer.plugin.timerId)&&clearTimeout(portal.data.timer.plugin.timerId),portal.data.timer.plugin.timerId=setTimeout(function(){portal.data.timer.plugin.lastUpdate=parseInt((new Date).getTime(),10);y(d,b,c)},6E4))},y=function(a,b,c){var d=function(){},e=function(){};"function"!==typeof b&&(d=function(){});"function"!==typeof c&&(e=function(){});$.ajax({url:"/portal/api/user/extention/update",type:"POST",data:a,dataType:"text",success:d,error:e})},z=function(a){var b="portal-style-default";
"red"===a?b="portal-style-red":"blue"===a?b="portal-style-blue":"green"===a&&(b="portal-style-green");$("body").removeClass().addClass(b)},N=function(){var a=function(){var a=$("#contents"),b;b=1+(a.outerHeight(!0)-a.height());b+=$("header").height();b+=$("footer").height();var e=$("html").prop("clientHeight")-b;b=$("#contents\x3e.content-active").css({"min-height":e+"px"}).find(".portal-iframe");if(b.length){var f=function(b){var d=b[0].contentDocument,k=d.querySelector('embed[name\x3d"plugin"][type\x3d"application/pdf"]');
b.hasClass("outside")||k?b.attr({width:Math.max(a.width()-40,640),height:e-5}).css({width:Math.max(a.width()-40,640)+"px",height:e-5+"px","min-height":e-5+"px"}):(b.removeAttr("style width height"),b.attr({width:Math.max(d.body.scrollWidth,a.width()-40,640)}),b.attr({height:d.body.scrollHeight}));b.off("load").on("load",function(){f($(this))})};f(b)}},b=0;$(window).on("resize",function(){clearTimeout(b);b=setTimeout(function(){a()},500)});$(document).on("hpjax:show",function(b,d){a()})},Q=function(a){var b=
$(a),c=b.find(".renew-icon");if(c.length){var d=null,e=0,f=function(){e+=10;c.css({transform:"rotate("+(0-e)+"deg)","-webkit-transform":"rotate("+(0-e)+"deg)","-moz-transform":"rotate("+(0-e)+"deg)","-ms-transform":"rotate("+(0-e)+"deg)"});d=setTimeout(f,50)};b.on("rotate:stop",function(){360>e?setTimeout(function(){b.trigger("rotate:stop")},50):(clearTimeout(d),b.off("rotate:stop"),c.css({transform:"","-webkit-transform":"","-moz-transform":"","-ms-transform":""}))});d=setTimeout(f,0)}},M=function(a){$("\x3cdiv /\x3e",
{"class":"top-label-error"}).on("click",function(){$(this).fadeOut(1E3,function(){$(this).remove()})}).html(a).appendTo("body")}})();