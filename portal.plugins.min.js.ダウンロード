var portal=portal||{};(function(){function f(){setTimeout(function(){g.text(h());f()},1E3)}function h(){var b=new Date,f=b.getFullYear(),g=b.getMonth()+1,h=b.getDate(),k=b.getHours(),l=b.getMinutes(),b=b.getSeconds();return f+"年"+g+"月"+h+"日 "+k+"時"+l+"分"+b+"秒"}portal.plugin=portal.plugin||{};portal.plugin.clock=portal.plugin.clock||{};var b=null,k=null,g=null;portal.plugin.clock.init=function(h,m){b=h;k=b.find("h1.content-part-title");g=b.find("div.content-part-body");k.text("時計");f()}})();
portal=portal||{};
(function(){portal.plugin=portal.plugin||{};portal.plugin.eye=portal.plugin.eye||{};var f=null,h=null,b=null;portal.plugin.eye.init=function(a,d){f=$(a);h=f.find("h1.content-part-title");b=f.find("div.content-part-body");h.text("出席管理システム");b.text("読み込み中...");k()};var k=function(){var a=vimana.util.getCache("eye");a?g(a):$.ajax({type:"GET",dataType:"JSON",url:"/eye/request/myinfo",cache:!1,success:function(a){a.lectures&&a.lectures.length?(a.term=(new Date(a.term)).getTime()||0,vimana.util.setCache({key:"eye",value:a.lectures,
term:a.term}),g(a.lectures)):g([])},error:function(){b.text("講義情報の取得に失敗しました")}})},g=function(a){vimana.util.setSchedule(1,q,null);$.each(a,function(a,c){vimana.util.setSchedule(c.begin_time,function(a){if(!(parseInt(c.end_time,10)<(new Date).getTime()))switch(a.role){case "TEACHER":case "ASSISTANT":u(a);break;case "STUDENT":"NONE"===a.status?m(a):n(a);break;default:alert("不正なユーザーを検知しました")}},c);vimana.util.setSchedule(c.end_time,function(){q()},null)})},p=function(a){var d=a.lecture_name,c=a.room_name,
e=$('\x3cdiv id\x3d"eye-content-left"/\x3e').css({"float":"left",width:"280px"}),d=$("\x3ch2/\x3e").text(d).css({"font-size":"14px","line-height":"24px","padding-top":"6px"}),c=$("\x3cp/\x3e").text(c).css({"margin-top":"2px","margin-bottom":"2px","font-size":"12px"});e.append(d);a.is_temp&&e.append("\x3c仮履修\x3e");e.append(c);null!==a.url&&""!==a.url&&(c=$('\x3cdiv id\x3d"eye-content-webpage"/\x3e'),d=vimana.factory.linkButton({value:"講義ページの表示",url:a.url,target:"_blank"}),d.attr("id","eye-webpage-button").css({"padding-top":"4px"}),
c.append(d),e.append(c));b.append(e);e=$('\x3cdiv id\x3d"eye-content-right"/\x3e');if("STUDENT"===a.role)switch(a.status){case "ATTENDING":e.append('\x3cimg src\x3d"/portal/public/img/eye/attend.gif"\x3e');break;case "AWAY":e.append('\x3cimg src\x3d"/portal/public/img/eye/away.gif"\x3e');break;case "ABSENCE":e.append('\x3cimg src\x3d"/portal/public/img/eye/absence.gif"\x3e');break;case "BLOCK":e.append('\x3cimg src\x3d"/portal/public/img/eye/block.gif"\x3e');break;case "NONE":e.append('\x3cimg src\x3d"/portal/public/img/eye/none.gif"\x3e')}else if("ASSISTANT"===
a.role||"TEACHER"===a.role)!1===a.is_active?e.append('\x3cimg src\x3d"/portal/public/img/eye/no_accept.gif"\x3e'):!0===a.is_accept_attendance?e.append('\x3cimg src\x3d"/portal/public/img/eye/accept.gif"\x3e'):e.append('\x3cimg src\x3d"/portal/public/img/eye/no_accept.gif"\x3e');b.append(e)},m=function(a){b.empty();f.show();p(a);var d=$('\x3cdiv id\x3d"eye-content-form"/\x3e').css({clear:"both","text-align":"right"}),c=vimana.factory.textLine("座席コードを入力してください").on("keypress",a,function(a){13===a.keyCode&&
s(a.data)});c.attr("id","eye-form-seatcode").css({width:"274px",height:"18px",margin:"0px"});var e=vimana.factory.button("出席").on("click",a,function(a){s(a.data)});e.attr("id","eye-form-status-button").css({width:"96px",height:"24px","text-align":"center",padding:"0px"});var s=function(a){var d=parseInt(c.val());t(d)?l(a,"ATTENDING",d,null):alert("座席コードが不正です")};d.append(c).append(e);a.is_temp&&(a=vimana.factory.button("他の部屋に出席する").on("click",function(){q()}),a.css({"margin-top":"20px"}),d.append(a));
b.append(d);d=$('\x3cp id\x3d"eye-information"/\x3e').css({color:"#777","background-color":"#eee","border-radius":"2px","margin-top":"6px",padding:"4px",clear:"both"}).text("座席コードを利用して出席を行ってください。");b.append(d)},n=function(a){var d=$('\x3cp id\x3d"eye-information"/\x3e');b.empty();f.show();p(a);if(!1===a.is_active)d.text("この講義は休講になりました");else{var c=$('\x3cdiv id\x3d"eye-content-form"/\x3e').css({clear:"both","text-align":"right"});switch(a.status){case "ATTENDING":var e=vimana.factory.button("一時退席する").on("click",
function(){l(a,"AWAY",a.seat_number,null)});e.attr("id","eye-form-status-button").css({width:"96px",height:"24px","text-align":"center",padding:"0px"});c.append(e);b.append(c);d.text("出席処理が完了し着席している状態です。").css({color:"#777","background-color":"#eee","border-radius":"2px","margin-top":"6px",padding:"4px"});break;case "AWAY":e=vimana.factory.button("着席する").on("click",function(){l(a,"ATTENDING",a.seat_number,null)});e.attr("id","eye-form-status-button").css({width:"96px",height:"24px","text-align":"center",
padding:"0px"});c.append(e);b.append(c);d.text("現在一時退席中です。講義終了までに着席してください。").css({color:"#777","background-color":"#eee","border-radius":"2px","margin-top":"6px",padding:"4px"});break;case "ABSENCE":d.text("不在状態とみなされたため操作できません").css({color:"#ff0000","background-color":"#eee","border-radius":"2px","margin-top":"6px",padding:"4px"});break;case "BLOCK":d.text("不正な出席とみなされたため操作できません").css({color:"#ff0000","background-color":"#eee","border-radius":"2px","margin-top":"6px",padding:"4px"})}}b.append(d)},
q=function(){b.empty();f.show();var a=$('\x3cdiv id\x3d"eye-content-form"/\x3e').css({clear:"both"}),d=vimana.factory.textLine("座席コードを入力してください [例: 9876]"),c=vimana.factory.textLine("部屋番号を入力してください [例: KE101]"),e=vimana.factory.button("出席").on("click",function(a){a=parseInt(d.val());var e=c.val();t(a)&&e.match("^[0-9A-Z]+[0-9]+$")?l({is_temp:!0,lecture_name:"(ページを再読み込みしてください)"},"ATTENDING",a,e):alert("部屋番号または座席コードが不正です")});a.append(c,d,e);b.append(a)},u=function(a){b.empty();f.show();p(a);var d=$('\x3cdiv id\x3d"eye-content-form"/\x3e').css({clear:"both",
"text-align":"right"});if(!1===a.is_active)d=$('\x3cp id\x3d"eye-information"/\x3e').text("開講は中止されました");else{var c=vimana.factory.linkButton({value:"座席表の表示",url:"/eye/seating_chart.html",target:"_blank"});c.attr("id","eye-teacher-seatview").css({width:"120px",height:"24px","text-align":"center",padding:"0px","margin-left":"2px"});d.append(c);"TEACHER"===a.role&&(c=vimana.factory.button("出席を受け付ける").on("click",function(){confirm("出席を再び受け付けますか？")&&r("OPEN")}),c.attr("id","eye-teacher-lecture-open"),
c.addClass("eye-form-teacher-button").css({width:"120px",height:"24px","text-align":"center",padding:"0px","margin-left":"2px"}),!0===a.is_accept_attendance&&c.css("display","none"),d.append(c),c=vimana.factory.button("出席を締め切る").on("click",function(){confirm("出席を締め切りますか？再び受け付ける事も可能です")&&r("CLOSE")}),c.attr("id","eye-teacher-lecture-close"),c.addClass("eye-form-teacher-button").css({width:"120px",height:"24px","text-align":"center",padding:"0px","margin-left":"2px"}),!1===a.is_accept_attendance&&c.css("display",
"none"),d.append(c),a=vimana.factory.button("休講にする").on("click",function(){confirm("講義を休講にしますか？この操作は取り消す事ができません")&&r("CANCEL")}),a.attr("id","eye-teacher-lecture-cancel"),a.addClass("eye-form-teacher-button").css({width:"120px",height:"24px","text-align":"center",padding:"0px","margin-left":"2px"}),d.append(a))}b.append(d)},l=function(a,d,c,e){var f={status:d,seat_code:c};null!==e&&(f.room_code=e);e={upload_data:JSON.stringify(f)};var g=function(a,c){if("information"===c)$("#eye-information").text(a);
else if("label"===c){var d=$('\x3clable class\x3d"portal-label"/\x3e').css({color:"#FF0000"}).text(a);b.empty().append(d)}};$.ajax({type:"POST",url:"/eye/request/attendance/update",data:e,success:function(e){e=JSON.parse(e);if("SUCCESS"===e.result){a.status=d;a.seat_number=c;n(a);e=a.lecture_id;for(var b=vimana.util.getCache("eye")||[],f=0;f<b.length;f++)b[f].lecture_id===e&&(b[f].status=d,b[f].seat_number=c);vimana.util.setCache({key:"eye",value:b})}else if("FAILURE"===e.result)switch(e.error_code){case "NOT_LECTURE_ACTIVE":g("この講義は休講になりました",
"label");break;case "ALREADY_ATTENDED_SEAT":g("その座席コードは既に他の人が登録しています、直ちに担当教員やTAに報告して下さい","information");break;case "ALREADY_ATTENDED_USER":g("あなたは既に出席登録を行なっています","label");break;case "INVALID_SEAT_NUMBER":g("座席コードが不正です。もう一度座席コードを見なおしてください","information");break;case "INVALID_STATUS":g("不在状態とみなされたため操作権限がありません","label");break;case "INVALID_USER":g("不正な出席とみなされたため操作権限がありません","label");break;case "NOT_ACCEPT_ATTENDANCE":g("出席が既に締め切られています","label");break;case "INVALID_DATA":g("講義や教室が見つかりませんでした","label");break;
case "EXTERNAL_IP":g("学外からのアクセスです","label");break;default:g("想定外のエラーです","label")}else g("想定外のエラーです","label")},error:function(){g("サーバーエラーが発生しました","label")}})},r=function(a){var d={};d.upload_data='{"command":"'+a+'"}';$.ajax({type:"POST",url:"/eye/request/room/update",data:d,dataType:"text",success:function(c){"SUCCESS"===JSON.parse(c).result&&("CLOSE"===a?($("#eye-teacher-lecture-open").css("display","inline"),$("#eye-teacher-lecture-close").css("display","none")):"OPEN"===a?($("#eye-teacher-lecture-open").css("display",
"none"),$("#eye-teacher-lecture-close").css("display","inline")):"CANCEL"===a&&(c=$('\x3clable class\x3d"portal-label"/\x3e').text("開講は中止されました"),b.html(c)))},error:function(a){alert("サーバーエラーが発生しました","label")}})},t=function(a){try{if(isFinite(a)&&!isNaN(a)){var d=parseInt(a/10,10);if(isNaN(d))throw Error("getCheckDigit:Illegal argument");for(var c=String(d),e=c.length,d=0,b=e;0<b;b--)d=0===(e-b+1)%2?d+1*c.substring(b-1,b):d+3*c.substring(b-1,b);if((10-d%10)%10===a%10)return!0}}catch(f){}return!1}})();
portal=portal||{};(function(){portal.plugin=portal.plugin||{};portal.plugin.notice=portal.plugin.notice||{};var f=null,h=[];portal.plugin.notice.init=function(b,k){f=$(b);f.hide();$.ajax({type:"GET",url:"/portal/notice/list",dataType:"text",success:function(b){h=JSON.parse(b).reverse();for(b=0;notice=h[b];b++){var k=f.clone(),m=k.find("h1.content-part-title"),n=k.find("div.content-part-body");m.text(notice.title);n.append(notice.body);f.after(k.show())}}})}})();